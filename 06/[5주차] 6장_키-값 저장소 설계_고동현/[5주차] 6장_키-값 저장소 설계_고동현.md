# [5주차] 6장 키-값 저장소 설계

### **핵심 개념**

- 키-값 저장소(Key-Value Store)는 고유한 식별자인 키(Key)와 그에 해당하는 값(Value)을 쌍으로 저장하는 비관계형 데이터베이스이다.
    - AWS DynamoDB , Redis

### **CAP 정리**

아래 3가지를 동시에 만족하는 분산 시스템을 설계하는 것을 불가능하고 하나는 희생해야한다.

![image.png](image.png)

- **데이터 일관성 (Consistency)**: 모든 클라이언트는 언제나 동일한 데이터를 본다
- **가용성 (Availability)**: 일부 노드에 장애가 발생해도 클라이언트는 항상 응답을 받을 수 있다
- **파티션 감내 (Partition Tolerance)**: 노드 간 통신 장애가 발생해도 시스템은 계속 동작
    - CA 시스템은 존재하지 않는다. 네트워크 장애는 피할 수 없는 일이고 파티션 문제를 감내할 수 있도록 설계되어야 하기 때문

### **핵심 컴포넌트 및 기술**

1. **데이터 파티션 (Data Partition)**
    - **목적**
        - 대규모 데이터를 여러 서버에 고르게 분산시키기 위함
        - 노드가 추가되거나 삭제 될 때 데이터의 이동을 최소화 할 수 있는가
    - **기술**: 안정 해시(Consistent Hashing)를 사용하여 서버가 추가되거나 삭제될 때 데이터 이동을 최소화
        - 안정 해시는 키를 해시 링(hash ring)에 배치하고, 키의 위치에서 시계 방향으로 가장 가까운 서버에 데이터를 저장하는 방식
2. **데이터 다중화 (Data Replication)**
    - **목적**: 높은 가용성과 안정성을 확보하기 위해 데이터를 여러 서버에 복제
    - **기술**: 안정 해시를 통해 키가 위치한 링의 특정 지점에서부터 시계 방향으로 N개의 서버에 데이터 사본을 보관
3. **데이터 일관성 (Data Consistency)**
    - **목적**: 여러 노드에 복제된 데이터의 동기화를 맞춤
    - **기술**: **정족수 합의(Quorum Consensus)** 프로토콜을 사용하여 읽기/쓰기 연산의 일관성을 보장
        - `N`: 사본 개수
        - `W`: 쓰기 연산에 대한 정족수. 쓰기 연산이 성공으로 간주되려면 최소 `W`개의 서버로부터 성공 응답을 받아야 한다.
        - `R`: 읽기 연산에 대한 정족수. 읽기 연산이 성공으로 간주되려면 최소 `R`개의 서버로부터 응답을 받아야 한다
        - `W + R > N`일 경우 강한 일관성(strong consistency)이 보장
4. **비일관성 해소: 데이터 버저닝**
    - **목적**: 데이터의 버전 충돌 문제를 해결
    - **기술**: 벡터 시계(Vector Clock)는 `[서버, 버전]`의 쌍으로 데이터의 버전을 기록하여 충돌을 감지하고 해결하는 데 사용
5. **장애 처리 (Failure Handling)**
    - **장애 감지 (Failure Detection)**: 가십 프로토콜(Gossip Protocol)을 사용하여 각 노드가 주기적으로 자신의 박동 카운터(heartbeat counter)를 주변 노드들과 교환하며 장애 상태를 감지
    - **일시적 장애 처리**: **느슨한 정족수(Sloppy Quorum)** 접근법과 **임시 위탁(Handoff)** 기법을 사용합니다. 쓰기/읽기 연산을 수행할 서버에 장애가 발생하면, 다른 건강한 서버가 대신 처리하고 나중에 원래 서버가 복구되면 데이터를 반환 한다.
    - **영구적 장애 처리**: **반-엔트로피(Anti-entropy) 프로토콜**을 구현하여 사본들을 동기화
        - 머클 트리(Merkle Tree)를 사용하여 데이터 차이가 있는 부분만 비교하고 전송 데이터의 양을 줄입니다.
6. **시스템 아키텍처**
    - 클라이언트는 **중재자(coordinator)** 역할을 하는 노드와 통신
    - 모든 노드는 같은 책임을 지므로 SPOF(Single Point of Failure)가 존재하지 않음
    - **쓰기 경로(Write Path)**: 쓰기 요청은 커밋 로그에 기록되고, 데이터는 메모리 캐시에 저장된 후, 특정 조건에서 디스크의 **SSTable**에 기록
    - **읽기 경로(Read Path)**: 데이터가 메모리 캐시에 있는지 먼저 확인하고, 없다면 디스크에서 가져옴
        - 이때 블룸 필터(Bloom Filter)를 사용해 특정 SSTable에 키가 존재하는지 빠르게 확인 가능