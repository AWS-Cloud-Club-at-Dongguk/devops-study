# 08. URL 단축기 설계

## 설계에 앞선 범위 확정 (예제)
- URL 단축기 동작: 특정 URL이 들어왔을 때, 단축 URL을 결과로 제공해야하며, 이 단축 URL에 접속하면 원래 URL로 리디렉션 돼야 함
- 트래픽 규모: 매일 1억개의 단축 URL을 만들어낼 수 있다고 가정
- URL의 길이: 짧을수록 좋음
- 단축 URL에 포함될 문자: 숫자(0-9), 영문자(a-z, A-Z)
- 단축된 URL을 시스템에서 지우거나 갱신할 수는 없다고 가정

- 주요 기능
  1. URL 단축: 주어진 긴 URL을 훨씬 짧게 줄인다.
  2. URL 리디렉션: 축약된 URL로 HTTP 요청이 오면 원래 URL로 안내
  3. 높은 가용성과 규모 확장성, 장애 감내

- 개략적 추정
  - 쓰기 연산: 매일 1억개의 단축 URL 생성
  - 초당 쓰기연산: 1억/24/3600 = 1160
  - 읽기 연산: 읽기 연산과 쓰기 연산의 비율이 10:1이라 했을 때, 읽기 연산은 초당 11,600회 발생 (1160 x 10)
  - URL 단축 서비스를 10년간 운영한다고 가정하면, 10억 x 365 x 10 = 3650억개의 레코드를 보관해야 한다.
  - 축약 전 URL의 평균 길이는 100이라고 가정
  - 따라서 10년동안 필요한 저장 용량은 3650억 x 100 바이트 = 36,5TB

## 개략적 설계안 제시
- API 엔드포인트
  - 두 개의 엔드포인트가 필요
  - 1. URL 단축용 엔드포인트
    - 단축할 URL을 인자로 실어 POST요청. 이 엔드포인트로 새 단축 URL을 생성함
    - ![image_1](images/image_1.jpg)
  - 2. URL 리디렉션용 엔드포인트
    - 단축 URL에 대해서 HTTP 요청이 오면 원래 URL을 응답으로 실어 GET 요청을 보내줌
    - ![image_2](images/image_2.jpg)
- URL 리디렉션
  - ![image_3](images/image_3.jpg)
  - 1. 브라우저에 단축 URL 입력
  - 2. 단축 URL을 받은 서버가 그 URL을 원래 URL로 바꾸어 301 응답의 Location 헤더에 넣어 반환
  - 301 응답 (301 Permanently Moved): 
    - 이 URL에 대한 HTTP 요청의 처리 책임이 영구적으로 Location 헤더에 반환된 URL로 이전되었다는 응답
    - 영구적으로 이전되었으므로, 브라우저는 이 응답을 캐시하여 추후 같은 단축 URL에 요청을 보낼 때 캐시된 원래 URL로 요청을 보냄
    - 서버 부하를 줄이는 데 용이: 첫 번째 요청만 단축 URL 서버로 전송되기 때문
  - 302 응답 (302 Found):
    - 이 응답은 주어진 URL로의 요청이 일시적으로 Location 헤더가 지정하는 URL에 의해 처리되어야 한다는 응답
    - 클라이언트의 요청은 언제나 단축 URL 서버에 먼저 보내진 후에 원래 URL로 리디렉션 됨
    - 트래픽 분석이 중요할 때 용이: 클릭 발생률, 발생 위치 추적에 유리
  - 해시 테이블을 이용하여 URL 리디렉션 구현
    - 해시테이블에 <단축 URL, 원래 URL>의 쌍을 저장한다고 가정하면 URL 리디렉션은 다음과 같이 구현됨
      - 원래 URL = hashTable.get(단축 URL)
      - 301 또는 302 응답 Location 헤더에 원래 URL을 넣은 후 전송
- URL 단축 플로우
  - ![image_4](images/image_4.jpg)
  - 단축 URL: www.tinyurl.com/{hashValue}라 할때, 기존 URL을 hashValue로 대응시킬 해시 함수 fx를 찾는 것이 중요
  - 해시 함수의 요구 사항
    - 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야 한다.
    - 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원할 수 있어야 한다.
## 상세 설계
- 데이터 모델
  - 개략적 설계 시에는 모든 것을 해시 테이블에 두었으나, 실제 시스템에서 메모리는 유한하고 비싸기 때문에 다른 방법 필요
  - ![image_5](images/image_5.jpg)
  - 실제 설계: <단축 URL, 원래 URL>의 순서쌍을 관계형 데이터베이스에 저장
- 해시 함수
  - 원래 URL을 단축 URL(hashValue)로 변환하는 데 쓰임
  - 해시 값 길이
    - hashValue는 [0-9, a-z, A-Z]의 문자로 구성됨. 사용 가능한 문자 개수: 62개
    -  -> 62^n >= 3650억인 n의 최소값을 찾아야 hashValue의 길이를 정할 수 있다.
       -  n은 대략 7   
  -  해시 후 충돌 해소 방법
     -  긴 URL을 줄이기 위해, 원래 URL을 7글자 문자열로 줄이는 해시 함수 필요
     -  CRC32, MD5, SHA-1 등 잘 알려진 해시 함수 이용하기
     -  그런데 이 해시 함수의 결과값인 해시값은 7보다는 길다. 이를 줄이는 방법
        -  1. 계산된 해시 값에서 처음 7개 글자만 이용하는 것
           - ![image_6](images/image_6.jpg)
           -  충돌이 실제로 발생하면, 충돌이 해소될 때까지 사전에 정한 문자열을 해시값에 붙임
           -  이 방법은 충돌 해소는 가능하지만, 단축 URL을 생성할 때 한 번 이상 데이터베이스 질의를 해야함: 오버헤드가 큼
              - 데이터베이스 대신 블룸 필터 이용 시 성능을 높일 수 있다
                - 블룸 필터: 어떤 집합에 특정 원소가 있는지 검사할 수 있도록 하는 기술    
        -  2. base-62 변환
  -  base-62 변환법
     -  진법 변환(base conversion)
     -  수의 표현 방식이 다른 두 시스템이 같은 수를 공유해야 하는 경우 유용
     -  62진법: hashValue에 사용할 수 있는 문자 개수가 62개 이기 때문
        -  예시
           - ![image_7](images/image_7.jpg)
           -  -> 단축 URL: https://tinyurl.com/2TX
  - 차이 비교
   - ![image_8](images/image_8.jpg)
- URL 단축 및 리디렉션
  - URL 단축기 상세 설꼐
   - ![image_9](images/image_9.jpg)
    - 1. 입력으로 긴 URL을 받음
    - 2. 데이터베이스에 해당 URL이 있는지 검사
    - 3. 데이터베이스에 있다면, 해당 URL에 대한 단축 URL을 만든 적이 있는 것.
      - -> 데이터베이스에서 해당 단축 URL을 가져와서 클라이언트에게 반환
    - 4. 데이터베이스에 없는 경우, 해당 URL은 새로 접수된 것이므로 유일한 ID를 생성함. 
      - 이 ID는 데이터베이스의 기본키로 사용됨
    - 5. 62진법 변환을 적용하여 ID를 단축 URL로 만듦
    - 6. ID, 단축 URL, 원래 URL로 새 데이터베이스 레코드를 만든 후 단축 URL을 클라이언트에게 전달
    - 예제
     - ![image_10](images/image_10.jpg)
    - 단축 URL 생성기의 주된 용도는 단축 URL을 만들 때 사용할 ID를 만드는 것이고, 이 ID는 전역적으로 유일해야 한다.
    - 고도로 분산된 환경에서 이런 생성기를 만드는 것은 어려움: 7장 분산 ID 생성기 내용 참고
  - URL 리디렉션 상세 설계
    - ![image_11](images/image_11.jpg)
    - URL 리디렉션 메커니즘 설계 예시
    - 쓰기보다 읽기를 더 자주 하는 시스템이라, <단축 URL, 원래 URL>의 쌍을 캐시에 저장하여 성능을 높임
    - 로드밸런서 동작 흐름
      - 1. 사용자가 단축 URL을 클릭
      - 2. 로드밸런서가 해당 클릭으로 발생한 요청을 웹 서버에 전달
      - 3. 단축 URL이 이미 캐시에 있는 경우, 원래 URL을 바로 꺼내서 클라이언트에게 전달
      - 4. 캐시에 해당 단축 URL이 없는 경우에는 데이터베이스에서 꺼냄
        - 데이터베이스에 없다면 사용자가 잘못된 단축 URL을 입력한 경우
      - 5. 데이터베이스에서 꺼낸 URL을 캐시에 넣은 후 사용자에게 반환
### 생각해 볼 사항들
- 처리율 제한 장치
  - 지금까지 가상 설계한 시스템은, 엄청난 양의 URL 단축 요청이 밀려들 경우 무력화될 수 있다는 보안 결함
  - 처리율 제한 장치를 두면, IP 주소를 비롯한 필터링 규칙을 이용해 요청을 걸러낼 수 있다.
  - 처리율 제한 장치 관련 내용: 4장 참고
- 웹 서버 규모 확장
  - 본 설계에 포함된 웹 계층은 무상태 계층이므로, 웹 서버를 자유롭게 증설, 삭제 가능
- 데이터베이스 규모 확장
  - 데이터베이스를 다중화하거나 샤딩하여 규모 확장성 달성 가능
- 데이터 분석 솔루션
  - URL 단축기에 데이터 분석 솔루션을 통합
    - 어떤 링크를 얼마나 많은 사용자가 클릭했는지, 주로 언제 클릭했는지 등 정보를 알아낼 수 있다
- 가용성, 데이터 일관성, 안정성
  - 대규모 시스템이 성공적으로 운영되기 위해 반드시 갖추어야 할 속성들
  - 1장 참고