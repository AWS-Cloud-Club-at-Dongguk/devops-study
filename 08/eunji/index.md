# URL 단축기 설계

## 목차
1. [문제 이해 및 설계 범위 확정](#1-문제-이해-및-설계-범위-확정)
2. [개략적 설계안](#2-개략적-설계안)
3. [상세 설계](#3-상세-설계)
4. [마무리](#4-마무리)

---

## 1. 문제 이해 및 설계 범위 확정

### 기본 요구사항
- **URL 단축**: 긴 URL을 짧게 변환
- **URL 리디렉션**: 단축 URL → 원본 URL로 HTTP 요청 전달
- **높은 가용성, 규모 확장성, 장애 감내** 필요

### 개략적 추정
- **쓰기 연산**: 매일 1억 개 단축 URL 생성
  - 초당 쓰기: 100M / 24 / 3600 = **1,160 QPS**
- **읽기 연산**: 쓰기:읽기 = 1:10
  - 초당 읽기: **11,600 QPS**
- **저장 용량** (10년 운영):
  - 레코드 수: 100M × 365 × 10 = **365억 개**
  - 평균 URL 길이: 100 바이트
  - 총 용량: 365억 × 100 = **36.5TB**

### 제약사항
- 단축 URL 문자: 숫자(0-9), 영문자(a-z, A-Z) → **62개 문자**
- 삭제/갱신 기능 없음 (단순화)

---

## 2. 개략적 설계안

### API 엔드포인트

#### 1) URL 단축
```
POST /api/v1/data/shorten
- 인자: { longUrl: string }
- 반환: 단축 URL
```

#### 2) URL 리디렉션
```
GET /api/v1/{shortUrl}
- 반환: HTTP 리디렉션 (301/302)
```

### HTTP 상태 코드 비교

| 상태 코드 | 의미 | 장점 | 단점 |
|---------|------|------|------|
| **301 Permanently Moved** | 영구 이전 | 브라우저 캐싱으로 서버 부하 감소 | 트래픽 분석 어려움 |
| **302 Found** | 일시 이전 | 클릭 추적 가능 (분석 유리) | 매번 서버 요청 필요 |

### URL 단축 흐름
```
긴 URL → 해시 함수 fx → hashValue → https://tinyurl.com/{hashValue}
```

**해시 함수 요구사항**:
- 입력이 다르면 해시값도 달라야 함
- 해시값으로 원본 URL 복원 가능해야 함

---

## 3. 상세 설계

### 데이터 모델

**관계형 DB 테이블 구조**:
```
| id (PK) | shortURL | longURL |
|---------|----------|---------|
```

### 해시 함수 설계

#### hashValue 길이 결정
- 사용 가능 문자: 62개 (0-9, a-z, A-Z)
- 필요 URL 개수: 365억 개

| n | 62^n | 생성 가능 URL 개수 |
|---|------|-------------------|
| 6 | 62^6 | 56억 |
| **7** | **62^7** | **3.5조** ✅ |
| 8 | 62^8 | 218조 |

→ **길이 7 선택** (요구사항 충족)

#### 방법 1: 해시 후 충돌 해소

**프로세스**:
1. CRC32, MD5, SHA-1 등으로 해시 생성
2. 처음 7자만 사용
3. 충돌 발생 시 → 문자열 추가 후 재시도

**예시**:
```
URL: https://en.wikipedia.org/wiki/Systems_design
CRC32: 5cb54054 (8자)
MD5: 5a62509a... (32자)
→ 처음 7자 추출
```

**단점**: DB 조회 오버헤드 (블룸 필터로 개선 가능)

#### 방법 2: base-62 변환 ⭐

**프로세스**:
1. 유일 ID 생성 (예: 2009215674938)
2. 62진법 변환
3. 단축 URL 생성

**예시**:
```
ID: 11157₁₀
→ 62진법 변환: 2 × 62² + 55 × 62¹ + 59 × 62⁰
→ [2, 55, 59] → [2, T, X]
→ 단축 URL: https://tinyurl.com/2TX
```

#### 두 방법 비교

| 구분 | 해시 후 충돌 해소 | base-62 변환 |
|------|------------------|--------------|
| URL 길이 | 고정 | 가변 (ID 증가에 따라) |
| 유일 ID 생성기 | 불필요 | **필요** |
| 충돌 가능성 | 있음 (해소 전략 필요) | 없음 |
| 보안 | 다음 URL 예측 불가 | ID 순차 증가로 예측 가능 ⚠️ |

### URL 단축 상세 흐름

```
1. 입력: longURL
2. DB에 존재? 
   - YES → 기존 단축 URL 반환
   - NO → 3단계
3. 유일 ID 생성
4. ID를 62진법 변환 → shortURL
5. (ID, shortURL, longURL) DB 저장
6. shortURL 반환
```

**예시**:
```
입력: https://en.wikipedia.org/wiki/Systems_design
ID: 2009215674938
62진법: zn9edcu
저장: (2009215674938, zn9edcu, https://...)
```

### URL 리디렉션 상세 설계

**아키텍처**:
```
사용자 → 로드밸런서 → 웹서버 → 캐시 → DB
```

**흐름**:
1. 사용자가 단축 URL 클릭
2. 로드밸런서 → 웹서버 전달
3. 캐시 확인
   - HIT → 원본 URL 즉시 반환
   - MISS → DB 조회 → 캐시 저장 → 반환
4. 301/302 리디렉션 응답

**최적화**: 읽기 >> 쓰기 → **캐시 활용** 필수

---

## 4. 마무리

### 추가 고려사항

#### 처리율 제한 장치 (Rate Limiter)
- IP 기반 필터링으로 대량 요청 차단
- DDoS 공격 방어

#### 규모 확장성
- **웹 계층**: 무상태(stateless) → 자유로운 증설/삭제
- **DB 계층**: 다중화, 샤딩

#### 데이터 분석
- 클릭 수, 시간대, 지역 등 추적
- 비즈니스 인사이트 확보

#### 가용성/일관성/안정성
- 다중화, 장애 복구 전략
- 데이터 백업 및 복제

---

## 핵심 요약

1. **해시 길이**: 62^7 = 3.5조 (7자 선택)
2. **추천 방식**: base-62 변환 (충돌 없음)
3. **ID 생성기**: 전역 유일성 보장 필요 (7장 참고)
4. **캐시 전략**: 읽기 중심 시스템 → 적극 활용
5. **상태 코드**: 301(캐싱) vs 302(분석) 트레이드오프

## 참고 문헌
- [RESTful Tutorial](https://www.restapitutorial.com/index.html)
- [Bloom Filter](https://en.wikipedia.org/wiki/Bloom_filter)
